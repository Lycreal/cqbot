import base64

from .message import generate_group_message

class MockResponse:
    image_base64 = ''.join("""
    Qk1mAAAAAAAAADYAAAAoAAAABAAAAAQAAAABABgAAAAAAA
    AAAADEDgAAxA4AAAAAAAAAAAAAJBzsJBzsJBzsJBzsJBzs
    APL/APL/JBzsJBzsAPL/APL/JBzsJBzsJBzsJBzsJBzs
    """.split())

class MockResponse:
    image_base64 = ''.join("""
    Qk1mAAAAAAAAADYAAAAoAAAABAAAAAQAAAABABgAAAAAAA
    AAAADEDgAAxA4AAAAAAAAAAAAAJBzsJBzsJBzsJBzsJBzs
    APL/APL/JBzsJBzsAPL/APL/JBzsJBzsJBzsJBzsJBzs
    """.split())

    def __init__(self, url):
        self.url = url

    async def aread(self):
        if 'https://api.lolicon.app/setu/' in self.url:
            return b'{"code":0,"msg":"","quota":275,"quota_min_ttl":3719,"count":10,"data":[{"pid":61480973,"p":0,"uid":4218982,"title":"\xe3\x83\x81\xe3\x83\xa7\xe3\x82\xb3\xe3\x81\xa8\xe3\x82\x8f\xe3\x81\x9f\xe3\x81\x97\xe3\x80\x81","author":"\xe8\x8a\xb1\xe5\xae\xae\xe3\x81\xaa\xe3\x81\xa4\xe3\x81\x8b","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2017\\/02\\/16\\/03\\/40\\/53\\/61480973_p0.jpg","r18":false,"width":800,"height":884,"tags":["\xe3\x82\xaa\xe3\x83\xaa\xe3\x82\xb8\xe3\x83\x8a\xe3\x83\xab","\xe5\x8e\x9f\xe5\x88\x9b","\xe3\x82\xb9\xe3\x82\xaf\xe6\xb0\xb4","\xe5\xad\xa6\xe7\x94\x9f\xe6\xb3\xb3\xe8\xa1\xa3","R-15","\xe8\xbc\xaa\xe3\x83\x81\xe3\x83\xa9","\xe4\xb9\xb3\xe6\x99\x95\xe5\xbe\xae\xe9\x9c\xb2","\xe5\xa5\xb3\xe3\x81\xae\xe5\xad\x90","\xe5\xa5\xb3\xe5\xad\xa9\xe5\xad\x90"]},{"pid":71658301,"p":0,"uid":21995968,"title":"rkgkV","author":"DeeCHA","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2018\\/11\\/15\\/00\\/00\\/06\\/71658301_p0.png","r18":false,"width":1384,"height":1640,"tags":["\xe3\x82\xa2\xe3\x82\xba\xe3\x83\xbc\xe3\x83\xab\xe3\x83\xac\xe3\x83\xbc\xe3\x83\xb3","\xe7\xa2\xa7\xe8\x93\x9d\xe8\x88\xaa\xe7\xba\xbf","\xe3\x83\xb4\xe3\x82\xa1\xe3\x83\xb3\xe3\x83\x91\xe3\x82\xa4\xe3\x82\xa2(\xe3\x82\xa2\xe3\x82\xba\xe3\x83\xbc\xe3\x83\xab\xe3\x83\xac\xe3\x83\xbc\xe3\x83\xb3)","\xe5\x90\xb8\xe8\xa1\x80\xe9\xac\xbc\xef\xbc\x88\xe7\xa2\xa7\xe8\x93\x9d\xe8\x88\xaa\xe7\xba\xbf\xef\xbc\x89","\xe7\x99\xbd\xe8\xa1\xa3\xe3\x81\xae\xe5\xb0\x8f\xe6\x82\xaa\xe9\xad\x94","\xe7\x99\xbd\xe8\xa1\xa3\xe5\xb0\x8f\xe6\x81\xb6\xe9\xad\x94","\xe5\x89\xa5\xe3\x81\x8e\xe5\x8f\x96\xe3\x82\x8a\xe3\x81\x9f\xe3\x81\x84\xe3\x83\x96\xe3\x83\xa9","\xe8\xae\xa9\xe4\xba\xba\xe6\x83\xb3\xe8\x84\xb1\xe6\x8e\x89\xe7\x9a\x84\xe8\x83\xb8\xe7\xbd\xa9"]},{"pid":72145426,"p":0,"uid":11109673,"title":"\xe3\x81\x93\xe3\x81\xad\xe3\x81\x93\xe3\x81\xa1\xe3\x82\x83\xe3\x82\x93\xe3\x81\xa8\xe6\xb8\xa9\xe6\xb3\x89","author":"\xe4\xb8\x89\xe6\x9d\x91\xe3\x81\x96\xe3\x81\x98\xe3\x82\x83","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2018\\/12\\/16\\/22\\/19\\/13\\/72145426_p0.png","r18":false,"width":920,"height":1299,"tags":["R-18","\xe3\x82\xaa\xe3\x83\xaa\xe3\x82\xb8\xe3\x83\x8a\xe3\x83\xab","\xe5\x8e\x9f\xe5\x88\x9b","\xe7\x8c\xab\xe8\x80\xb3","cat ears","\xe6\xb8\xa9\xe6\xb3\x89","onsen","\xe5\x85\xa8\xe8\xa3\xb8","completely naked"]},{"pid":72488624,"p":1,"uid":16134546,"title":"\xe6\x98\x8e\xe3\x81\x91\xe3\x81\xbe\xe3\x81\x97\xe3\x81\xa6\xe3\x81\x8a\xe3\x82\x81\xe3\x81\xa7\xe3\x81\xa8\xe3\x81\x86\xe3\x81\x94\xe3\x81\x96\xe3\x81\x84\xe3\x81\xbe\xe3\x81\x99\xef\xbc\x81","author":"\xe3\x81\xad\xe3\x82\x81\xe7\x8c\xab\xe2\x91\xa5","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2019\\/01\\/04\\/16\\/15\\/15\\/72488624_p1.png","r18":false,"width":3117,"height":2309,"tags":["\xe5\xb9\xb4\xe8\xb3\x80\xe7\x8a\xb6","\xe8\xb4\xba\xe5\xb9\xb4\xe5\x8d\xa1","\xe5\xb9\xb4\xe8\xb3\x80\xe7\xb5\xb5","New Year\'s illustration","\xe5\xa5\xb3\xe3\x81\xae\xe5\xad\x90","\xe5\xa5\xb3\xe5\xad\xa9\xe5\xad\x90","\xe3\x83\x91\xe3\x83\xb3\xe3\x83\x81\xe3\x83\xa9","\xe9\x9c\xb2\xe5\x86\x85\xe8\xa3\xa4"]},{"pid":75977200,"p":0,"uid":270915,"title":"C96\xe6\x96\xb0\xe5\x88\x8a\xe8\xa1\xa8\xe7\xb4\x99\xe6\x96\x87\xe5\xad\x97\xe3\x81\xaa\xe3\x81\x97\xe7\x89\x88","author":"\xe7\xa7\x8b\xe6\x9c\x88\xe3\x81\xbe\xe3\x81\x8f","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2019\\/07\\/30\\/00\\/06\\/16\\/75977200_p0.png","r18":false,"width":1700,"height":2378,"tags":["Fate\\/GrandOrder","\xe9\xaf\x96\xe3\x81\x90\xe3\x81\xa0\xe2\x99\x80","Servant\\/Gudako","\xe4\xbb\xa5\xe3\x81\x90\xe3\x81\xa0\xe2\x99\x80","\xe4\xbb\xa5\xe8\x97\x8f\xc3\x97\xe5\x92\x95\xe5\x93\x92\xe2\x99\x80","\xe3\x81\x90\xe3\x81\xa0\xe5\xad\x90","\xe5\x92\x95\xe5\x93\x92\xe5\xad\x90","\xe9\xbb\x92\xe3\x82\xb9\xe3\x83\x88","\xe9\xbb\x91\xe4\xb8\x9d\xe8\xa2\x9c","R-18","\xe7\xa0\xb4\xe3\x82\x8c\xe3\x82\xbf\xe3\x82\xa4\xe3\x83\x84","\xe7\xa0\xb4\xe6\x8d\x9f\xe7\x9a\x84\xe4\xb8\x9d\xe8\xa2\x9c","\xe3\x83\x91\xe3\x83\xb3\xe3\x82\xb9\xe3\x83\x88\xe8\xb6\x8a\xe3\x81\x97\xe3\x81\xae\xe3\x83\x91\xe3\x83\xb3\xe3\x83\x84","\xe9\x9a\x94\xe7\x9d\x80\xe4\xb8\x9d\xe8\xa2\x9c\xe7\x9a\x84\xe5\x86\x85\xe8\xa3\xa4","\xe7\xa0\xb4\xe3\x82\x8c\xe3\x82\xb9\xe3\x83\x88\xe3\x83\x83\xe3\x82\xad\xe3\x83\xb3\xe3\x82\xb0"]},{"pid":80673012,"p":0,"uid":14496985,"title":"Amiya\xe3\x80\x90Arknights\xe3\x80\x91","author":"ChinTora0201","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2020\\/04\\/09\\/20\\/36\\/19\\/80673012_p0.png","r18":false,"width":910,"height":1522,"tags":["\xe6\x98\x8e\xe6\x97\xa5\xe6\x96\xb9\xe8\x88\x9f","Arknights","\xe9\x98\xbf\xe7\xb1\xb3\xe5\xa8\x85","Amiya","\xe3\x81\x8a\xe3\x81\xa3\xe3\x81\xb1\xe3\x81\x84","\xe6\xac\xa7\xe6\xb4\xbe","amiya","\xe3\x82\xa8\xe3\x83\x97\xe3\x83\xad\xe3\x83\xb3","\xe5\x9b\xb4\xe8\xa3\x99","\xe8\xa3\xb8\xe3\x82\xa8\xe3\x83\x97\xe3\x83\xad\xe3\x83\xb3","\xe8\xa3\xb8\xe4\xbd\x93\xe5\x9b\xb4\xe8\xa3\x99","\xe9\xad\x85\xe6\x83\x91\xe3\x81\xae\xe3\x81\xb5\xe3\x81\xa8\xe3\x82\x82\xe3\x82\x82","\xe9\xad\x85\xe6\x83\x91\xe7\x9a\x84\xe5\xa4\xa7\xe8\x85\xbf","\xe3\x82\xa2\xe3\x83\xbc\xe3\x82\xaf\xe3\x83\x8a\xe3\x82\xa4\xe3\x83\x84"]},{"pid":85949998,"p":0,"uid":24222104,"title":"\xe3\x83\xa2\xe3\x83\x8a\xe3\x81\xa1\xe3\x82\x83\xe3\x82\x93","author":"HOURAKU","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2020\\/11\\/28\\/07\\/00\\/00\\/85949998_p0.jpg","r18":false,"width":977,"height":1382,"tags":["\xe5\x8e\x9f\xe7\xa5\x9e","Genshin Impact","\xe3\x83\xa2\xe3\x83\x8a","Mona","\xe3\x81\xad\xe3\x81\x98\xe8\xbe\xbc\xe3\x81\xbf\xe3\x81\x9f\xe3\x81\x84\xe5\xb0\xbb","\xe8\xbf\x99\xe5\xb1\x81\xe8\x82\xa1\xe8\xae\xa9\xe4\xba\xba\xe6\x83\xb3\xe8\x82\x9b","\xe3\x81\xb1\xe3\x82\x93\xe3\x81\xa4","\xe8\x83\x96\xe6\xac\xa1","\xe3\x83\xa2\xe3\x83\x8a(\xe5\x8e\x9f\xe7\xa5\x9e)","\xe8\x8e\xab\xe5\xa8\x9c\xef\xbc\x88\xe5\x8e\x9f\xe7\xa5\x9e\xef\xbc\x89","\xe5\xb0\xbb\xe7\xa5\x9e\xe6\xa7\x98","\xe5\xb0\xbb\xe7\xa5\x9e\xe6\xa0\xb7"]},{"pid":83958094,"p":1,"uid":7203802,"title":"\xe6\x98\x8e\xe6\x97\xa5\xe6\x96\xb9\xe8\x88\x9f","author":"Shio","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2020\\/08\\/27\\/01\\/55\\/25\\/83958094_p1.jpg","r18":false,"width":2480,"height":3508,"tags":["\xe6\x98\x8e\xe6\x97\xa5\xe6\x96\xb9\xe8\x88\x9f","Arknights","\xe5\xb7\xab\xe6\x81\x8b","Shamare","\xe6\xb3\xa1\xe6\x99\xae\xe5\x8d\xa1","Popukar","\xe9\x9b\xaa\xe9\x9b\x89","Snowsant","\xe8\x90\x9d\xe8\x8e\x89","loli","\xe7\x9d\xa1\xe8\xa1\xa3","\xe5\x85\xbd\xe8\x80\xb3","animal ears","\xe7\x99\xbd\xe3\x82\xbf\xe3\x82\xa4\xe3\x83\x84","\xe7\x99\xbd\xe8\xa3\xa4\xe8\xa2\x9c","\xe3\x82\xb7\xe3\x83\xa3\xe3\x83\x9e\xe3\x83\xac(\xe3\x82\xa2\xe3\x83\xbc\xe3\x82\xaf\xe3\x83\x8a\xe3\x82\xa4\xe3\x83\x84)","\xe5\xb7\xab\xe6\x81\x8b\xef\xbc\x88\xe6\x98\x8e\xe6\x97\xa5\xe6\x96\xb9\xe8\x88\x9f\xef\xbc\x89"]},{"pid":88049572,"p":0,"uid":12563125,"title":"\xe3\x83\xa2\xe3\x83\x8a","author":"jademoon","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2021\\/02\\/26\\/00\\/03\\/48\\/88049572_p0.png","r18":false,"width":1500,"height":1875,"tags":["\xe3\x83\xa2\xe3\x83\x8a","Mona","\xe5\x8e\x9f\xe7\xa5\x9e","Genshin Impact","GenshinImpact","Mona(GenshinImpact)","\xe5\xb0\xbb","\xe5\xb1\x81\xe8\x82\xa1","\xe3\x81\x8a\xe5\xb0\xbb","\xe8\x87\x80\xe9\x83\xa8","\xe9\xbb\x92\xe3\x82\xb9\xe3\x83\x88","\xe9\xbb\x91\xe4\xb8\x9d\xe8\xa2\x9c","\xe3\x82\xa2\xe3\x82\xb9\xe3\x83\x88\xe3\x83\xad\xe3\x83\xbc\xe3\x82\xae\xe3\x82\xb9\xe3\x83\x88\xe3\x83\xbb\xe3\x83\xa2\xe3\x83\x8a\xe3\x83\xbb\xe3\x83\xa1\xe3\x82\xae\xe3\x82\xb9\xe3\x83\x88\xe3\x82\xb9","\xe9\x98\xbf\xe6\x96\xaf\xe6\x89\x98\xe6\xb4\x9b\xe5\x90\x89\xe6\x96\xaf\xc2\xb7\xe8\x8e\xab\xe5\xa8\x9c\xc2\xb7\xe6\xa2\x85\xe5\xa7\xac\xe6\x96\xaf\xe5\x9b\xbe\xe6\x96\xaf"]},{"pid":89169777,"p":0,"uid":2080437,"title":"\xe3\x80\x90\xe3\x82\xaa\xe3\x83\xaa\xe3\x82\xad\xe3\x83\xa3\xe3\x83\xa9\xe3\x80\x91","author":"SPiCA","url":"https:\\/\\/i.pximg.net\\/img-original\\/img\\/2021\\/04\\/15\\/20\\/46\\/53\\/89169777_p0.png","r18":false,"width":700,"height":990,"tags":["\xe3\x82\xaa\xe3\x83\xaa\xe3\x82\xb8\xe3\x83\x8a\xe3\x83\xab","\xe5\x8e\x9f\xe5\x88\x9b","\xe3\x82\xaa\xe3\x83\xaa\xe3\x82\xad\xe3\x83\xa3\xe3\x83\xa9","\xe5\x8e\x9f\xe5\x88\x9b\xe8\xa7\x92\xe8\x89\xb2","\xec\xb0\xbd\xec\x9e\x91","creation","\xe5\xb0\x91\xe5\xa5\xb3","young girl","\xe3\x83\x84\xe3\x82\xa4\xe3\x83\xb3\xe3\x83\x86\xe3\x83\xbc\xe3\x83\xab","\xe5\x8f\x8c\xe9\xa9\xac\xe5\xb0\xbe"]}]}'
        elif 'i.pximg.net' in self.url:
            return base64.b64decode(self.image_base64)
        else:
            raise


def test_setu(websocket, monkeypatch):
    async def mock_get(self, url, **kwargs):
        return MockResponse(url)

    with monkeypatch.context() as m:
        m.setattr('httpx.AsyncClient.get', mock_get)
        websocket.send_json(generate_group_message(websocket.self_id, '色图'))
        respond = websocket.receive_json()

    assert any(message['type'] == 'image' for message in respond['params']['message'])
